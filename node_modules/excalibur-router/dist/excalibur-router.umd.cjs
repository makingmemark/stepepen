(function(h,r){typeof exports=="object"&&typeof module<"u"?r(exports,require("excalibur")):typeof define=="function"&&define.amd?define(["exports","excalibur"],r):(h=typeof globalThis<"u"?globalThis:h||self,r(h["excalibur-router"]={},h.excalibur))})(this,function(h,r){"use strict";class w extends r.Scene{constructor(){super(...arguments),this.labels=[],this.elapsedTime=0,this.complete=!1}onInitialize(t){const e={sm:Math.max(t.drawHeight,t.drawWidth)/28,lg:Math.max(t.drawHeight,t.drawWidth)/10};this.progressBar=new m({x:t.drawWidth/2,y:t.drawHeight/2,width:t.drawWidth*.75,height:Math.round(e.sm)}),t.add(this.progressBar)}onActivate(){this.complete=!1}onLoad(t){this.progressBar.progress=t}onLoadComplete(){this.complete=!0,this.progressBar.actions.clearActions()}onPreUpdate(t,e){this.elapsedTime+=e}}class m extends r.Actor{constructor(t){super(t),this.progress=0}onInitialize(t){const e=new r.Canvas({width:this.width,height:this.height,quality:window.devicePixelRatio,draw:s=>{r.Util.DrawUtil.roundRect(s,0,0,this.width,this.height,this.height/2,r.Color.White),r.Util.DrawUtil.roundRect(s,0,0,this.width*Math.max(.05,Math.min(1,this.progress/100)),this.height,this.height/2,r.Color.White,r.Color.White)}});this.graphics.use(e)}}class y extends r.Class{constructor(t){super(),this.data=[],this.canvas={draw(){}},this.addResources(t!=null?t:[])}async load(){let t=0;const e=this.data.filter(i=>!i.isLoaded());this.emit("start",e),this.emit("progress",new g(this,0));const s=await Promise.all(e.map(i=>i.load().finally(()=>{t++,this.emit("progress",new g(this,t/e.length*100))})));return this.emit("progress",new g(this,100)),this.emit("complete",e),s}addResources(t){this.data.push(...t.filter(e=>!e.isLoaded()))}isLoaded(){return this.data.every(t=>t.isLoaded())}wireEngine(){}update(){}draw(){}}class g extends r.GameEvent{constructor(t,e){super(),this.target=t,this.progress=e}}class S extends r.Class{constructor(t){super(),this.isTransitioning=!1,this.isBooting=!0,this.resourceLoader=new y,this.routes=t.routes,this.loaders={default:w,...t.loaders}}get location(){const t=Object.keys(this.routes).find(e=>this.engine.scenes[e]===this.engine.currentScene);return t||console.warn("Unable to determine name for current scene, was it loaded outside of the router?"),{...this.lastGoto,name:t,scene:this.engine.currentScene}}start(t){return this.engine=t,this.isBooting=!0,Object.entries(this.routes).forEach(([e,s])=>{f(s)&&this.engine.add(e,new s)}),Object.entries(this.loaders).forEach(([e,s])=>{this.engine.add(e,new s)}),t.start(null)}addRoute(t,e){this.routes[t]=e,f(e)&&this.engine.add(t,new e)}removeRoute(t){delete this.routes[t],delete this.engine.scenes[t]}async goto(t,e={}){const s=e.transition;this.emit("navigationstart",{to:t,...e}),this.engine.currentScene.transition&&this.engine.currentScene.transition.kill(),this.engine.currentScene.transition=s;let i=this.engine.scenes[t];if(!this.routes[t])throw new Error(`No scene named ${t}`);return this.sceneNeedsLoading(t)?i=await this.loadScene(t,e):await this.executeTransition({type:"outro",transition:s}),i.once("activate",()=>{var o;(o=e.onActivate)==null||o.call(e,i)}),this.engine.goToScene(t,e.data),this.lastGoto={name:t,data:e.data},this.emit("navigation",{to:t,...e}),await this.executeTransition({type:"intro",transition:s}),this.engine.currentScene.transition=null,this.emit("navigationend",{to:t,...e}),this.isBooting=!1,i}async preloadScene(t){var s,i;let e=this.engine.scenes[t];if(this.sceneNeedsLoading(t)){if(!e){const d=this.routes[t],u=f(d)?d:await d().then(a=>a.default?a.default:a);if(u)e=new u,e.name=t,this.engine.add(t,e);else throw new Error(`"${t}" did not return a Scene`)}const o=this.engine.currentScene,l=new Promise(d=>{o.defer?o.once("continue",d):d(void 0)});(s=o.onLoadStart)==null||s.call(o);const c=({progress:d})=>{var u,a;(a=(u=this.engine.currentScene).onLoad)==null||a.call(u,d)};this.resourceLoader.on("progress",c),await this.resourceLoader.load(),(i=o.onLoadComplete)==null||i.call(o),this.resourceLoader.off("progress",c),await l}return e}async loadScene(t,e={}){var o;const s=e.transition,i=(o=e.loader)!=null?o:"default";if(this.sceneNeedsLoading(t)){this.isBooting||await this.executeTransition({type:"outro",transition:s}),this.engine.goToScene(i);let l,c=Boolean(s&&this.isBooting);!this.isBooting&&s&&(s.persistOnLoading!==!1&&this.engine.currentScene.add(s),typeof s.persistOnLoading=="number"?l=setTimeout(()=>{this.executeTransition({type:"intro",transition:s}),c=!0},s.persistOnLoading):s.persistOnLoading===!1&&(await this.executeTransition({type:"intro",transition:s}),c=!0)),await this.preloadScene(t),c&&(this.isBooting&&this.engine.currentScene.add(s),await this.executeTransition({type:"outro",transition:s})),clearTimeout(l)}return this.engine.scenes[t]}addResource(t){return this.resourceLoader.addResources(Array.isArray(t)?t:[t])}async restartScene(t={}){var i;const e=this.lastGoto.name;if(!e)throw new Error("Scene was not navigated to using router, unable to restart.");await this.executeTransition({type:"outro",transition:t.transition});const s=this.engine.currentScene;this.engine.remove(s),this.addRoute(e,this.routes[e]),await this.goto(e,{...t,transition:null,data:(i=t.data)!=null?i:this.lastGoto.data}),await this.executeTransition({type:"intro",transition:t.transition})}sceneNeedsLoading(t){return this.engine.scenes[t]?!this.resourceLoader.isLoaded():!0}async executeTransition({type:t,transition:e,progress:s=0}){var o,l,c,d;const i=this.engine.currentScene;return e&&(this.isTransitioning=!0,i.isTransitioning=!0,i.add(e),t==="outro"?(o=i.onOutroStart)==null||o.call(i):(l=i.onIntroStart)==null||l.call(i),e.on("outro",u=>{var a;(a=i.onOutro)==null||a.call(i,u)}),e.on("intro",u=>{var a;(a=i.onIntro)==null||a.call(i,u)}),await e.execute(t==="outro",s),t==="intro"?((c=i.onIntroComplete)==null||c.call(i),e.kill()):(d=i.onOutroComplete)==null||d.call(i),i.isTransitioning=!1,this.isTransitioning=!1),e}}function f(n){return O(n)}function O(n){if(typeof n!="function")return!1;const t=Object.getOwnPropertyDescriptor(n,"prototype");return t?!t.writable:!1}class p extends r.Actor{constructor({duration:t=300,easing:e=i=>i,...s}={}){super(s),this.isOutro=!1,this.progress=0,this.started=!1,this.duration=typeof t=="number"?{outro:t,intro:t}:t,this.easing=e,this.persistOnLoading=s.persistOnLoading,this.on("preupdate",i=>{this.started&&(this.progress+=Math.min(i.delta/this.getDuration(),1),this.emit(this.isOutro?"outro":"intro",this.easing(this.progress)),this.progress>=1&&(this.emit(this.isOutro?"outrocomplete":"introcomplete",void 0),this.started=!1,this.progress=0))}),this.on("introstart",this.onIntroStart.bind(this)),this.on("intro",this.onIntro.bind(this)),this.on("introcomplete",this.onIntroComplete.bind(this)),this.on("outrostart",this.onOutroStart.bind(this)),this.on("outro",this.onOutro.bind(this)),this.on("outrocomplete",this.onOutroComplete.bind(this))}getDuration(){return this.isOutro?this.duration.outro:this.duration.intro}onIntroStart(){}onIntro(t){}onIntroComplete(){}onOutroStart(){}onOutro(t){}onOutroComplete(){}async execute(t,e=0){return this.isOutro=t,this.isInitialized||await new Promise(s=>{this.on("initialize",s)}),this.started=!0,this.progress=e,this.emit(t?"outrostart":"introstart",void 0),new Promise(s=>{this.on(t?"outrocomplete":"introcomplete",()=>{s(null)})})}}class v extends p{constructor(t={}){super({duration:300,z:1/0,persistOnLoading:200,...t})}onInitialize(t){this.el=new r.ScreenElement({x:-1,y:-1,z:this.z,width:t.canvasWidth+1*2,height:t.canvasHeight+1*2,color:r.Color.Black}),this.el.graphics.opacity=this.isOutro?0:1,this.addChild(this.el),this.el.scene=this.scene}onIntroStart(){this.el.graphics.opacity=1}onOutroStart(){this.el.graphics.opacity=0}onIntro(t){this.el.graphics.opacity=1-t}onOutro(t){this.el.graphics.opacity=t}}class L extends p{constructor({duration:t,...e}={}){super({...e,duration:{outro:0,intro:t!=null?t:150},z:1/0})}onInitialize(t){this.el=new r.ScreenElement({x:0,y:0,z:this.z,width:t.canvasWidth,height:t.canvasHeight}),this.el.graphics.use(new r.Canvas({quality:window.devicePixelRatio,width:t.canvasWidth,height:t.canvasHeight,draw:e=>{this.screenshot&&e.drawImage(this.screenshot,0,0,t.canvasWidth,t.canvasHeight,0,0,t.canvasWidth/t.pixelRatio,t.canvasHeight/t.pixelRatio)}})),this.addChild(this.el)}onIntroStart(){this.el.graphics.opacity=1}onOutroStart(){this.takeScreenshot()}onIntro(t){this.el.graphics.opacity=1-t}onOutro(t){}onOutroComplete(){}takeScreenshot(){this.scene.engine.screenshot(!0).then(t=>{this.screenshot=t})}}h.CrossFadeTransition=L,h.DefaultLoader=w,h.FadeTransition=v,h.Router=S,h.Transition=p,Object.defineProperties(h,{__esModule:{value:!0},[Symbol.toStringTag]:{value:"Module"}})});
